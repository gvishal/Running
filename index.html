<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon Run Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.8.0/suncalc.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .form-select-multiple {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat, repeat;
            background-position: right .7em top 50%, 0 0;
            background-size: .65em auto, 100%;
        }
        /* Styles for AI-generated content for better mobile readability */
        #planContent h3 {
            @apply text-xl font-semibold text-gray-700 mb-3 border-b pb-2;
        }
        #planContent ul {
            @apply list-disc list-inside space-y-2 mt-2 pl-2;
        }
        #planContent table {
            @apply w-full text-sm text-left text-gray-500 mt-2;
        }
        #planContent thead {
             @apply text-xs text-gray-700 uppercase bg-gray-50;
        }
        #planContent th, #planContent td {
            @apply px-4 py-3;
        }
        #planContent tbody tr {
             @apply bg-white border-b;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600">Marathon Run Planner</h1>
            <p class="text-gray-600 mt-2">Your personal guide for optimal race day nutrition and pacing.</p>
        </header>

        <main class="space-y-8">
            <!-- User Input Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">1. Plan Your Run</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Run Details -->
                    <div>
                        <label for="distance" class="block text-sm font-medium text-gray-700">Distance</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="number" id="distance" class="flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300" value="42.2">
                            <select id="unit" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                <option value="km" selected>km</option>
                                <option value="miles">miles</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="pace" class="block text-sm font-medium text-gray-700">Target Pace (min/unit)</label>
                        <input type="text" id="pace" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="7:30">
                    </div>
                     <div>
                        <label for="weight" class="block text-sm font-medium text-gray-700">Your Weight (kg)</label>
                        <input type="number" id="weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="70">
                    </div>
                    <div>
                        <label for="water" class="block text-sm font-medium text-gray-700">Water Carry Capacity (ml)</label>
                        <input type="number" id="water" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="600">
                    </div>
                    <div>
                        <label for="caffeine" class="block text-sm font-medium text-gray-700">Caffeine Preference</label>
                        <select id="caffeine" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm form-select">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Weather Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">2. Weather Conditions</h2>
                <div class="flex items-center space-x-4">
                     <input type="text" id="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Enter city, e.g., New York">
                    <button id="getLocationBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button id="getWeatherBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">Get Weather</button>
                </div>
                <div id="weatherResult" class="mt-4 text-gray-700"></div>
            </div>

            <!-- Products Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">3. Select Your Nutrition</h2>
                <div>
                    <label for="products" class="block text-sm font-medium text-gray-700">Choose from your available products:</label>
                    <select id="products" multiple class="mt-1 block w-full rounded-md border-gray-300 shadow-sm h-40 form-select-multiple">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div id="selectedProducts" class="mt-6">
                    <h3 class="text-lg font-medium">Selected Products Nutrition:</h3>
                    <div class="overflow-x-auto mt-2">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Carbs (g)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sodium (mg)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Potassium (mg)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Caffeine (mg)</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

             <!-- Generate Plan Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold mb-4 border-b pb-2">4. Generate Your Plan</h2>
                 <div class="flex flex-col items-center space-y-4">
                    <button id="generateHeuristicBtn" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">Generate Standard Plan</button>
                    <div class="w-full md:w-2/3 text-center">
                        <p class="text-gray-500 my-2">-- OR --</p>
                        <div class="space-y-2">
                             <input type="password" id="apiKey" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Enter your Gemini API Key here">
                             <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-600 hover:underline">How to get a Gemini API Key</a>
                        </div>
                        <button id="generateAIBtn" class="mt-2 w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">Generate Plan with AI</button>
                    </div>
                 </div>
            </div>
        </main>

        <!-- Plan Output Section -->
        <div id="planOutput" class="mt-10 bg-white p-6 rounded-lg shadow-md hidden">
             <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Your Marathon Plan</h2>
                <button id="copyPlanBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-6 4h.01M9 16h.01" /></svg>
                    Copy Plan
                </button>
            </div>
            <div id="loader" class="hidden my-4 flex justify-center items-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
                <p class="ml-4 text-gray-600">Generating AI plan... this may take a moment.</p>
            </div>
            <div id="planContent" class="space-y-6">
                <!-- Content will be populated by JS -->
            </div>
        </div>
    </div>
    <footer class="text-center py-8 text-gray-500">
        <p>Made for NYC Marathon training by <a href="https://www.strava.com/athletes/41189017" target="_blank" class="text-blue-600 hover:underline">Vishal</a></p>
    </footer>
    <div id="copy-message" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden">
        Plan copied to clipboard!
    </div>


    <script>
        // --- DATA ---
        const productsData = {
            // Salt Stick
            "Salt Stick Fastchews": { carbs: 1, sodium: 50, potassium: 15, caffeine: 0, serving: "2 tablets" },
            "Salt Stick Caps": { carbs: 0, sodium: 215, potassium: 63, caffeine: 0, serving: "1 capsule" },
            "Salt Stick Drink Mix": { carbs: 4, sodium: 430, potassium: 120, caffeine: 0, serving: "1 scoop" },
             // SIS
            "SIS GO Isotonic Gel": { carbs: 22, sodium: 10, potassium: 10, caffeine: 0, serving: "1 gel (60ml)" },
            "SIS GO Energy + Caffeine Gel": { carbs: 22, sodium: 15, potassium: 15, caffeine: 75, serving: "1 gel (60ml)" },
            "SIS Beta Fuel Gel": { carbs: 40, sodium: 30, potassium: 0, caffeine: 0, serving: "1 gel (60ml)" },
            "SIS Beta Fuel Chews": { carbs: 46, sodium: 20, potassium: 0, caffeine: 0, serving: "1 bar (60g)" },
            // GU
            "GU Energy Gel": { carbs: 22, sodium: 60, potassium: 40, caffeine: 20, serving: "1 gel (32g)" },
            "GU Roctane Energy Gel": { carbs: 21, sodium: 125, potassium: 55, caffeine: 35, serving: "1 gel (32g)" },
            "GU Energy Chews": { carbs: 20, sodium: 50, potassium: 40, caffeine: 0, serving: "4 chews" },
            // Maurten
            "Maurten Gel 100": { carbs: 25, sodium: 35, potassium: 0, caffeine: 0, serving: "1 gel (40g)" },
            "Maurten Gel 100 Caf 100": { carbs: 25, sodium: 35, potassium: 0, caffeine: 100, serving: "1 gel (40g)" },
            "Maurten Drink Mix 160": { carbs: 40, sodium: 160, potassium: 0, caffeine: 0, serving: "1 sachet" },
            // Liquid IV
            "Liquid IV Hydration Multiplier": { carbs: 11, sodium: 500, potassium: 370, caffeine: 0, serving: "1 stick (16g)" },
            "Liquid IV Energy Multiplier": { carbs: 8, sodium: 380, potassium: 300, caffeine: 100, serving: "1 stick (16g)" },
        };

        // --- DOM ELEMENTS ---
        const el = {
            distance: document.getElementById('distance'),
            unit: document.getElementById('unit'),
            pace: document.getElementById('pace'),
            weight: document.getElementById('weight'),
            water: document.getElementById('water'),
            caffeine: document.getElementById('caffeine'),
            location: document.getElementById('location'),
            getLocationBtn: document.getElementById('getLocationBtn'),
            getWeatherBtn: document.getElementById('getWeatherBtn'),
            weatherResult: document.getElementById('weatherResult'),
            products: document.getElementById('products'),
            productsTable: document.getElementById('productsTable'),
            apiKey: document.getElementById('apiKey'),
            generateHeuristicBtn: document.getElementById('generateHeuristicBtn'),
            generateAIBtn: document.getElementById('generateAIBtn'),
            planOutput: document.getElementById('planOutput'),
            planContent: document.getElementById('planContent'),
            loader: document.getElementById('loader'),
            copyPlanBtn: document.getElementById('copyPlanBtn'),
            copyMessage: document.getElementById('copy-message'),
        };

        // --- STATE ---
        let weatherData = null;
        let coords = null;

        // --- INITIALIZATION ---
        function init() {
            populateProducts();
            loadApiKey();
            el.products.addEventListener('change', updateSelectedProductsTable);
            el.getLocationBtn.addEventListener('click', getUserLocation);
            el.getWeatherBtn.addEventListener('click', fetchWeather);
            el.generateHeuristicBtn.addEventListener('click', () => generatePlan('heuristic'));
            el.generateAIBtn.addEventListener('click', () => generatePlan('ai'));
            el.copyPlanBtn.addEventListener('click', copyPlanToClipboard);
        }
        
        function loadApiKey() {
            const savedApiKey = localStorage.getItem('marathonPlannerApiKey');
            if (savedApiKey) {
                el.apiKey.value = savedApiKey;
            }
        }

        function populateProducts() {
            Object.keys(productsData).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                el.products.appendChild(option);
            });
        }

        // --- UI UPDATES ---
        function updateSelectedProductsTable() {
            el.productsTable.innerHTML = '';
            const selectedOptions = Array.from(el.products.selectedOptions);
            if (selectedOptions.length === 0) {
                 el.productsTable.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No products selected.</td></tr>`;
                 return;
            }
            selectedOptions.forEach(option => {
                const productName = option.value;
                const data = productsData[productName];
                const row = `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap">${productName}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${data.carbs}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${data.sodium}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${data.potassium}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${data.caffeine}</td>
                    </tr>
                `;
                el.productsTable.innerHTML += row;
            });
        }
        
        function displayPlan(htmlContent) {
            el.planContent.innerHTML = htmlContent;
            el.planOutput.classList.remove('hidden');
            el.loader.classList.add('hidden');
            el.planOutput.scrollIntoView({ behavior: 'smooth' });
        }

        // --- API & DATA FETCHING ---
        function getUserLocation() {
            if (navigator.geolocation) {
                el.weatherResult.textContent = 'Fetching location...';
                navigator.geolocation.getCurrentPosition(position => {
                    coords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    el.location.value = 'Current Location';
                    fetchWeather();
                }, (error) => {
                    let msg = 'Unable to retrieve your location. Please enter it manually.';
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    if (window.location.protocol !== 'https:') {
                         msg += ' For best results, please use a secure (https) connection.';
                    }
                    if (isIOS) {
                        msg += ' Check Settings > Privacy > Location Services to ensure Safari has access.';
                    }
                    el.weatherResult.textContent = msg;
                });
            } else {
                el.weatherResult.textContent = 'Geolocation is not supported by your browser.';
            }
        }
        
        async function fetchWeather() {
            el.weatherResult.textContent = 'Fetching weather...';
            let lat, lon;

            if (el.location.value === 'Current Location' && !coords) {
                 el.weatherResult.textContent = 'Could not determine current location. Please enter a location manually.';
                 return;
            }

            if (coords && el.location.value === 'Current Location') {
                lat = coords.latitude;
                lon = coords.longitude;
            } else if (el.location.value) {
                try {
                    const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(el.location.value)}&count=1`);
                    const geoData = await geoResponse.json();
                    if (geoData.error) {
                        el.weatherResult.textContent = `Geocoding Error: ${geoData.reason}`; return;
                    }
                    if (!geoData.results || geoData.results.length === 0) {
                        el.weatherResult.textContent = 'Could not find location. Please be more specific.'; return;
                    }
                    lat = geoData.results[0].latitude;
                    lon = geoData.results[0].longitude;
                    coords = { latitude: lat, longitude: lon };
                } catch (error) {
                    console.error('Geocoding fetch error:', error);
                    el.weatherResult.textContent = 'Error fetching location data. Check network connection.'; return;
                }
            } else {
                el.weatherResult.textContent = 'Please enter a location or allow location access.'; return;
            }

            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m`;
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.error) {
                    el.weatherResult.textContent = `Weather API Error: ${data.reason}`; weatherData = null; return;
                }
                if (!data.current || typeof data.current.temperature_2m === 'undefined') {
                     el.weatherResult.textContent = 'Unexpected weather data format.'; weatherData = null; return;
                }
                weatherData = {
                    temp: data.current.temperature_2m,
                    humidity: data.current.relative_humidity_2m,
                };
                const locationName = el.location.value || 'your location';
                el.weatherResult.innerHTML = `<strong>Current Weather in ${locationName}:</strong> Temperature: ${weatherData.temp}°C, Humidity: ${weatherData.humidity}%`;
            } catch (error) {
                console.error('Weather fetch error:', error);
                el.weatherResult.textContent = 'Failed to fetch weather data. Check network connection.';
                weatherData = null;
            }
        }

        // --- PLAN GENERATION ---
        function generatePlan(type) {
             const selectedProducts = Array.from(el.products.selectedOptions).map(opt => ({ name: opt.value, ...productsData[opt.value] }));
            if (selectedProducts.length === 0) {
                alert("Please select at least one nutrition product."); return;
            }
            if (type === 'ai' && !el.apiKey.value) {
                alert("Please enter your Gemini API Key to generate a plan with AI."); el.apiKey.focus(); return;
            }
            
            const apiKey = el.apiKey.value;
            if(apiKey){
                localStorage.setItem('marathonPlannerApiKey', apiKey);
            }

            const inputs = {
                distance: parseFloat(el.distance.value),
                unit: el.unit.value,
                pace: el.pace.value,
                weight: parseFloat(el.weight.value),
                waterCapacity: parseFloat(el.water.value),
                caffeinePref: el.caffeine.value,
                weather: weatherData,
                products: selectedProducts,
                location: el.location.value,
                apiKey: apiKey,
            };

            if(type === 'heuristic') {
                const planHTML = generateHeuristicPlan(inputs);
                displayPlan(planHTML);
            } else {
                generateAIPlan(inputs);
            }
        }

        function generateHeuristicPlan(inputs) {
            const [paceMinutes, paceSeconds] = inputs.pace.split(':').map(Number);
            const paceInMinutes = paceMinutes + paceSeconds / 60;
            const totalTimeMinutes = inputs.distance * paceInMinutes;
            const totalTimeHours = totalTimeMinutes / 60;
            const distanceKm = inputs.unit === 'miles' ? inputs.distance * 1.60934 : inputs.distance;
            const fluidNeedsPerHour = (inputs.weather && inputs.weather.temp > 20) ? 750 : 500;
            const totalFluidNeeds = fluidNeedsPerHour * totalTimeHours;
            let nutritionPlan = [];
            const fuelProducts = inputs.products.filter(p => p.carbs > 5 && (p.name.toLowerCase().includes('gel') || p.name.toLowerCase().includes('chew')));
            const electrolyteProducts = inputs.products.filter(p => p.sodium > 150 && (p.name.toLowerCase().includes('stick') || p.name.toLowerCase().includes('caps') || p.name.toLowerCase().includes('drink mix')));
            const numIntervals = Math.floor(distanceKm / 5);
            const caffFuel = fuelProducts.filter(p => p.caffeine > 0).sort((a,b) => a.caffeine - b.caffeine);
            const nonCaffFuel = fuelProducts.filter(p => p.caffeine === 0);
            for (let i = 1; i <= numIntervals; i++) {
                const currentDist = i * 5;
                if (currentDist > distanceKm - 4) break;
                let productToTake = null;
                if (i <= 2 && caffFuel.length > 0) {
                    productToTake = caffFuel[(i-1) % caffFuel.length];
                } else if (nonCaffFuel.length > 0) {
                    productToTake = nonCaffFuel[(i-1) % nonCaffFuel.length];
                } else if (fuelProducts.length > 0) {
                    productToTake = fuelProducts[(i-1) % fuelProducts.length];
                }
                if (productToTake) {
                    nutritionPlan.push({ point: `${currentDist.toFixed(0)} km`, item: productToTake.name, serving: productToTake.serving });
                }
            }
            if (electrolyteProducts.length > 0 && totalTimeHours > 2) {
                 const electrolyte = electrolyteProducts[0];
                 const midRunDist = Math.floor(distanceKm / 2);
                 nutritionPlan.push({ point: `~${midRunDist} km`, item: electrolyte.name, serving: electrolyte.serving });
                 nutritionPlan.sort((a,b) => parseFloat(a.point) - parseFloat(b.point));
            }
            const waterRefills = Math.ceil(totalFluidNeeds / inputs.waterCapacity) - 1;
            const waterPlan = [];
            if (waterRefills > 0) {
                for (let i = 1; i <= waterRefills; i++) {
                    const refillDistance = (i / (waterRefills + 1)) * distanceKm;
                    waterPlan.push(`Refill your ${inputs.waterCapacity}ml bottle/flask around ${refillDistance.toFixed(1)} km.`);
                }
            }
            const now = new Date();
            const sunTimes = SunCalc.getTimes(now, coords ? coords.latitude : 40.71, coords ? coords.longitude : -74.00);
            const sunset = sunTimes.sunset;
            const latestStartTime = new Date(sunset.getTime() - totalTimeMinutes * 60000);
            const carbLoadingPlan = [];
            for (let i = 3; i > 0; i--) {
                const carbs = (8 + (3-i)*2) * inputs.weight;
                carbLoadingPlan.push(`<strong>Day ${4-i} before race:</strong> Aim for ${carbs.toFixed(0)}g of carbohydrates. Focus on simple carbs and reduce fiber.`);
            }
            const easyPace = paceInMinutes * 1.1;
            const fastPace = paceInMinutes * 0.95;
            const pacePlan = `<li><strong>First 5km:</strong> Start easy, about 10% slower than target pace (~${(easyPace).toFixed(2).replace('.',':')} min/${inputs.unit}).</li><li><strong>5km to 35km:</strong> Settle into your target pace of ${inputs.pace} min/${inputs.unit}.</li><li><strong>Last 7km:</strong> If feeling good, increase effort slightly to ~${(fastPace).toFixed(2).replace('.',':')} min/${inputs.unit}.</li>`;
            let html = `<div><h3 class="text-xl font-semibold text-gray-700">Run Summary</h3><p><strong>Total Estimated Time:</strong> ${Math.floor(totalTimeHours)}h ${Math.round(totalTimeMinutes % 60)}m</p><p><strong>Latest Safe Start Time:</strong> <span class="text-red-600 font-bold">${latestStartTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span> to finish before sunset.</p></div><div><h3 class="text-xl font-semibold text-gray-700">Carb Loading Plan (3 Days Out)</h3><ul class="list-disc list-inside space-y-1 mt-2">${carbLoadingPlan.map(item => `<li>${item}</li>`).join('')}</ul></div><div><h3 class="text-xl font-semibold text-gray-700">Pre-Run Plan (Morning of)</h3><ul class="list-disc list-inside space-y-1 mt-2"><li><strong>3 hours before:</strong> Eat a high-carb, low-fiber meal (~100g carbs).</li><li><strong>1-2 hours before:</strong> Drink 500ml of water or electrolyte drink.</li><li><strong>15 mins before:</strong> Optional - take one energy gel.</li></ul></div><div><h3 class="text-xl font-semibold text-gray-700">Mid-Run Nutrition & Hydration Plan</h3><p class="text-sm text-gray-500">Drink small sips of water every 15-20 minutes.</p><table class="min-w-full divide-y divide-gray-200 mt-2"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left">Time / Distance</th><th class="px-4 py-2 text-left">Action</th></tr></thead><tbody>${nutritionPlan.map(p => `<tr><td class="px-4 py-2 font-medium">${p.point}</td><td class="px-4 py-2">Take ${p.serving} of <strong>${p.item}</strong></td></tr>`).join('')}${waterPlan.map(p => `<tr><td class="px-4 py-2 font-medium text-blue-600">Water Stop</td><td class="px-4 py-2 text-blue-600">${p}</td></tr>`).join('')}</tbody></table></div><div><h3 class="text-xl font-semibold text-gray-700">Pacing Strategy</h3><ul class="list-disc list-inside space-y-1 mt-2">${pacePlan}</ul></div><div><h3 class="text-xl font-semibold text-gray-700">Post-Run Recovery</h3><ul class="list-disc list-inside space-y-1 mt-2"><li><strong>Within 30 mins:</strong> Consume a mix of carbs and protein (3:1 ratio). A recovery shake or chocolate milk is ideal.</li><li><strong>Throughout the day:</strong> Rehydrate with water and electrolytes. Eat a balanced meal.</li></ul></div><div><h3 class="text-xl font-semibold text-gray-700">Caffeine Warning</h3><p>Monitor your total caffeine intake. This plan is based on your preference but listen to your body. High caffeine can cause jitters or stomach issues for some.</p></div>`;
            return html;
        }

        async function generateAIPlan(inputs) {
            el.planOutput.classList.remove('hidden');
            el.planContent.innerHTML = '';
            el.loader.classList.remove('hidden');
            el.planOutput.scrollIntoView({ behavior: 'smooth' });
            
            const apiKey = inputs.apiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const productsString = inputs.products.map(p => `- ${p.name} (Carbs: ${p.carbs}g, Sodium: ${p.sodium}mg, Potassium: ${p.potassium}mg, Caffeine: ${p.caffeine}mg, Serving: ${p.serving})`).join('\n');
            const now = new Date();
            const sunTimes = SunCalc.getTimes(now, coords ? coords.latitude : 40.71, coords ? coords.longitude : -74.00);
            const sunset = sunTimes.sunset;

            const prompt = `
                Act as an expert running coach creating a personalized marathon race plan. Here is the user's data:
                - Race Distance: ${inputs.distance} ${inputs.unit}, Target Pace: ${inputs.pace} min/${inputs.unit}
                - Runner's Weight: ${inputs.weight} kg, Water Capacity: ${inputs.waterCapacity} ml, Caffeine Preference: ${inputs.caffeinePref}
                - Location: ${inputs.location || 'Not provided. Assume New York City.'}
                - Weather: ${inputs.weather ? `Temp: ${inputs.weather.temp}°C, Humidity: ${inputs.weather.humidity}%` : 'Not available. Assume moderate conditions.'}
                - Available Nutrition:
                ${productsString}

                **Task:**
                Generate a comprehensive, actionable race plan in clean, mobile-friendly HTML.
                **HTML Formatting Rules:**
                - Wrap each logical section in a simple \`<div>\`.
                - Use \`<h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">\` for section titles.
                - Use \`<ul class="list-disc list-inside space-y-2 mt-2 pl-2">\` for lists.
                - For the main nutrition schedule, use a responsive table: \`<table class="w-full text-sm text-left text-gray-500 mt-2"><thead class="text-xs text-gray-700 uppercase bg-gray-50">...\` and use standard \`tbody\`, \`tr\`, \`th\`, and \`td\` elements with padding.
                
                **Plan Sections & Logic:**
                1.  **Run Summary:** Calculate total run time. The local sunset time is ${sunset.toLocaleTimeString()}. Calculate the latest safe start time to finish 15 minutes before sunset.
                2.  **Carb Loading Plan (3 Days):** Simple day-by-day carb intake goal (g) based on runner's weight.
                3.  **Pre-Run Plan:** What/when to eat/drink race morning.
                4.  **Mid-Run Nutrition & Hydration Plan (Table):** Create a schedule (Kilometer/Mile vs. Action).
                    - Intake at intervals of ~5 kilometers (or ~3 miles).
                    - Recommend **ONE** product per interval.
                    - **Alternate** between selected fuel types (gels/chews).
                    - Schedule **caffeinated products in the first half** of the run.
                    - **No nutrition in the last 5km**.
                    - Schedule water refills based on capacity and estimated fluid loss.
                5.  **Pacing Strategy:** A simple 3-stage pacing plan.
                6.  **Post-Run Recovery:** Actionable advice for the 30 mins after finishing.
                7.  **Caffeine Warning:** A brief, friendly warning.

                Output only the raw HTML for the plan sections, ready to be injected into a div. Do not include \`\`\`html, \`<html>\`, or \`<head>\` tags.
            `;

            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }], };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API Error: ${response.statusText}`); }
                const result = await response.json();
                const planHTML = result.candidates[0].content.parts[0].text;
                displayPlan(planHTML);

            } catch (error) {
                console.error("AI Plan Generation Error:", error);
                el.loader.classList.add('hidden');
                el.planContent.innerHTML = `<p class="text-red-500">Sorry, there was an error generating the AI plan. Please check your API key and connection. Error: ${error.message}</p>`;
            }
        }
        
        function copyPlanToClipboard() {
            const planText = el.planContent.innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = planText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            el.copyMessage.classList.remove('hidden');
            setTimeout(() => { el.copyMessage.classList.add('hidden'); }, 2000);
        }

        // --- START THE APP ---
        init();

    </script>

</body>
</html>


